"""
Filtro Hodrick-Prescott del PIB per c치pita de Espa침a (Desde el a침o 2000)

Este script carga datos hist칩ricos del PIB per c치pita de Espa침a, aplica el filtro Hodrick-Prescott 
para extraer la tendencia a largo plazo y visualiza los resultados junto con eventos econ칩micos importantes.
"""

import pandas as pd
import statsmodels.api as sm
import matplotlib.pyplot as plt

# 游늷 Ruta del archivo Excel (Aseg칰rate de ajustar la ruta correcta)
file_path = "C:/Users/aitor.bernal/OneDrive - HMY/Escritorio/mpd2020.xlsx"

# 游댳 Cargar la hoja de datos completos
df = pd.read_excel(file_path, sheet_name="Full data")

# 游댳 Filtrar los datos solo para Espa침a
df_spain = df[df["country"] == "Spain"].copy()

# 游댳 Ordenar los datos por a침o
df_spain = df_spain.sort_values(by="year")

# 游늷 Aplicar el filtro de Hodrick-Prescott al PIB per c치pita (gdppc)
# El filtro HP descompone una serie en ciclo y tendencia. Aqu칤 usamos 풭 = 6.25 recomendado para datos anuales.
cycle, trend = sm.tsa.filters.hpfilter(df_spain["gdppc"].dropna(), lamb=6.25)

# 游댳 Agregar las series filtradas al DataFrame
df_spain.loc[df_spain["gdppc"].notna(), "trend"] = trend
df_spain.loc[df_spain["gdppc"].notna(), "cycle"] = cycle

# 游댳 Filtrar los datos desde el a침o 2000 en adelante
df_spain_filtered = df_spain[df_spain["year"] >= 2000]

# 游늵 Crear el gr치fico
plt.figure(figsize=(12, 6))
plt.plot(df_spain_filtered["year"], df_spain_filtered["gdppc"], label="PIB per c치pita (Original)", alpha=0.5, color="steelblue")
plt.plot(df_spain_filtered["year"], df_spain_filtered["trend"], label="Tendencia (HP Filter)", linewidth=2, color="darkorange")

# 游댳 Eventos econ칩micos importantes en Espa침a
events = {
    2008: "Crisis Financiera Global",
    2010: "Crisis de la Deuda Europea",
    2012: "Rescate Bancario de Espa침a"
}

# 游댳 Marcar los eventos en el gr치fico con l칤neas verticales y etiquetas
for year, event in events.items():
    plt.axvline(x=year, color='red', linestyle='dashed', alpha=0.7, linewidth=1.5)  # L칤nea discontinua roja
    plt.text(year, df_spain_filtered["gdppc"].max() * 0.85, event, 
             rotation=0, fontsize=10, color='red', ha='right', 
             bbox=dict(facecolor='white', alpha=0.8, edgecolor='red'))

# 游늷 Etiquetas y t칤tulo
plt.xlabel("A침o")
plt.ylabel("PIB per c치pita")
plt.title("Filtro Hodrick-Prescott del PIB per c치pita de Espa침a (Desde 2000) con eventos econ칩micos")
plt.legend()
plt.grid(True, linestyle="--", alpha=0.6)

# 游댳 Mostrar el gr치fico
plt.show()
